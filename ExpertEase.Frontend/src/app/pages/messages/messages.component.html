<div class="chat-wrapper">
  <div class="chat-container">
    <div class="sidebar">
      <div class="sidebar-header">Convorbiri</div>
      <div
        class="conversation"
        *ngFor="let conv of exchanges"
        (click)="loadExchange(conv.userId)"
        [class.active]="conv.userId === selectedExchange?.userId">
        <img src="assets/avatar.svg" alt="avatar">
        {{ conv.userFullName }}
      </div>
    </div>

    <div class="chat-area" *ngIf="selectedExchange; else noSelection">
      <div class="chat-header">
        <div>{{ selectedExchange.userFullName }}</div>
        <div>
          <button>
            <img src="assets/icons/info.svg" alt="specialist_info" [routerLink]="['/specialist', selectedExchange.userId]">
          </button>
        </div>
      </div>

      <div class="chat-messages">
        <!-- Use the new typed conversation items method -->
        <ng-container *ngFor="let itemWrapper of getTypedConversationItems()">
          <ng-container [ngSwitch]="itemWrapper.type">

            <!-- Valid Message Bubble -->
            <app-message-bubble
              *ngSwitchCase="'message'"
              [message]="asTypedMessage(itemWrapper)"
              [currentUserId]="userId">
            </app-message-bubble>

            <!-- Valid Request Message -->
            <app-request-message
              *ngSwitchCase="'request'"
              [request]="asTypedRequest(itemWrapper)"
              (requestAccepted)="acceptRequest(itemWrapper.item.id)"
              (requestRejected)="rejectRequest(itemWrapper.item.id)">
            </app-request-message>

            <!-- Valid Reply Message -->
<!--            <app-reply-message-->
<!--              *ngSwitchCase="'reply'"-->
<!--              [reply]="asTypedReply(itemWrapper)"-->
<!--              (replyAccepted)="acceptReply(itemWrapper.item.data.requestId, itemWrapper.item.data.id)"-->
<!--              (replyRejected)="rejectReply(itemWrapper.item.data.requestId, itemWrapper.item.data.id)">-->
<!--            </app-reply-message>-->

            <!-- Error handling for unknown/invalid items -->
            <div *ngSwitchCase="'unknown'" class="error-message">
              <p>⚠️ Invalid conversation item (ID: {{ itemWrapper.item.id }})</p>
              <details>
                <summary>Debug Info</summary>
                <pre>{{ itemWrapper.item | json }}</pre>
              </details>
            </div>

          </ng-container>
        </ng-container>

        <!-- Empty state -->
        <div *ngIf="!selectedExchange?.conversationItems?.length" class="empty-conversation">
          <p>No messages yet. Start the conversation!</p>
        </div>
      </div>

      <div class="chat-input">
        <button>
          <img src="assets/icons/photo_media.svg" alt="photo_media" (click)="openMediaPicker()">
        </button>
        <input
          type="text"
          placeholder="Scrie un mesaj aici"
          [(ngModel)]="messageContent"
          (keydown.enter)="sendMessage(messageContent)"
        />
        <button
          class="send-btn"
          (click)="sendMessage(messageContent)"
          [disabled]="!messageContent.trim()">
          →
        </button>
      </div>
    </div>

    <ng-template #noSelection>
      <div class="chat-area empty">
        <p>Nu există conversații disponibile.</p>
      </div>
    </ng-template>
  </div>
</div>
