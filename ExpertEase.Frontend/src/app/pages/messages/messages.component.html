<div class="chat-wrapper">
  <div class="chat-container">
    <div class="sidebar">
      <div class="sidebar-header">Convorbiri</div>
      <div
        class="conversation"
        *ngFor="let conv of exchanges"
        (click)="loadExchange(conv.userId)"
        [class.active]="conv.userId === selectedExchange?.userId">
        <img src="assets/avatar.svg" alt="avatar">
        {{ conv.userFullName }}
      </div>
    </div>

    <div class="chat-area" *ngIf="selectedExchange; else noSelection">
      <div class="chat-header">
        <div>{{ selectedExchange.userFullName }}</div>
        <div>
          <button>
            <img src="assets/icons/info.svg" alt="specialist_info" [routerLink]="['/specialist', selectedExchange.userId]">
          </button>
        </div>
      </div>

      <div class="chat-messages">
        <ng-container *ngFor="let item of selectedExchange?.conversationItems">
          <ng-container [ngSwitch]="item.type">

            <!-- Message Bubble -->
            <app-message-bubble
              *ngSwitchCase="'message'"
              [message]="asMessage(item)"
              [currentUserId]="userId">
            </app-message-bubble>

            <!-- Request Message -->
            <app-request-message
              *ngSwitchCase="'request'"
              [request]="asRequest(item)"
              (requestAccepted)="acceptRequest(item.id)"
              (requestRejected)="rejectRequest(item.id)">
            </app-request-message>

<!--            &lt;!&ndash; Reply Message &ndash;&gt;-->
<!--            <app-reply-message-->
<!--              *ngSwitchCase="'reply'"-->
<!--              [reply]="asReply(item)"-->
<!--              (replyAccepted)="acceptReply(item.data.requestId, item.data.id)"-->
<!--              (replyRejected)="rejectReply(item.data.requestId, item.data.id)">-->
<!--            </app-reply-message>-->
          </ng-container>
        </ng-container>

<!--        <ng-container *ngFor="let request of selectedExchange.requests">-->
<!--          &lt;!&ndash; Request message &ndash;&gt;-->
<!--          <div [ngClass]="userRole === 'Client' ? 'message-right' : 'message-left'">-->
<!--            <app-request-message-->
<!--              [request]="request"-->
<!--              (requestAccepted)="acceptRequest(request.id)"-->
<!--              (requestRejected)="rejectRequest(request.id)"-->
<!--              (makeOffer)="openReplyForm($event)">-->
<!--            </app-request-message>-->
<!--            <div class="conversation-overlay" *ngIf="isReplyFormVisible && selectedRequestId === request.id">-->
<!--              <app-reply-form-->
<!--                [replyForm]="replyForm"-->
<!--                (formSubmit)="submitReply($event)"-->
<!--                (close)="closeReplyForm()">-->
<!--              </app-reply-form>-->
<!--            </div>-->
<!--          </div>-->

<!--          <ng-container *ngFor="let reply of selectedExchange.replies.filter(r => r.requestId === request.id)">-->
<!--            <div [ngClass]="userRole === 'Client' ? 'message-left' : 'message-right'">-->
<!--              <app-reply-message-->
<!--                [reply]="reply"-->
<!--                [requestId]="request.id"-->
<!--                (replyAccepted)="acceptReply($event.requestId, $event.replyId)"-->
<!--                (replyRejected)="rejectReply($event.requestId, $event.replyId)">-->
<!--              </app-reply-message>-->
<!--            </div>-->

<!--            <ng-container *ngIf="hasActiveServiceTask(request)">-->
<!--              <div class="conversation-overlay">-->
<!--                <ng-container *ngIf="isReviewFormVisible; else showTaskOverlay">-->
<!--                  <app-review-form-->
<!--                    [reviewForm]="reviewForm"-->
<!--                    (formSubmit)="submitReview($event)"-->
<!--                    (close)="closeReviewForm()">-->
<!--                  </app-review-form>-->
<!--                </ng-container>-->

<!--                <ng-template #showTaskOverlay>-->
<!--&lt;!&ndash;                  <app-service-message&ndash;&gt;-->
<!--&lt;!&ndash;                    [serviceTask]="getLastReplyWithServiceTask(request)?.serviceTask!"&ndash;&gt;-->
<!--&lt;!&ndash;                    [replyId]="getLastReplyWithServiceTask(request)?.id!"&ndash;&gt;-->
<!--&lt;!&ndash;                    (taskCompleted)="completeTask($event.replyId, $event.taskId)"&ndash;&gt;-->
<!--&lt;!&ndash;                    (taskCancelled)="cancelTask($event.replyId, $event.taskId)">&ndash;&gt;-->
<!--&lt;!&ndash;                  </app-service-message>&ndash;&gt;-->
<!--                </ng-template>-->
<!--              </div>-->
<!--            </ng-container>-->
<!--          </ng-container>-->
<!--        </ng-container>-->
      </div>

      <div class="chat-input">
        <button>
          <img src="assets/icons/photo_media.svg" alt="photo_media" (click)="openMediaPicker()">
        </button>
        <input
          type="text"
          placeholder="Scrie un mesaj aici"
          [(ngModel)]="messageContent"
          (keydown.enter)="sendMessage(messageContent)"
        />
        <button class="send-btn" (click)="sendMessage(messageContent)">→</button>
      </div>
    </div>
    <ng-template #noSelection>
      <div class="chat-area empty">
        <p>Nu există conversații disponibile.</p>
      </div>
    </ng-template>
  </div>
</div>

<!--<div class="overlay" *ngIf="isReplyFormVisible">-->
<!--  <app-reply-form-->
<!--    [replyForm]="replyForm"-->
<!--    (formSubmit)="submitReply($event)"-->
<!--    (close)="closeReplyForm()">-->
<!--  </app-reply-form>-->
<!--</div>-->

